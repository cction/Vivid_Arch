# BananaPod 项目状态记录

## UI 设计标准（PodUI v1.x）

### UI 设计标准草案

#### 设计令牌（Design Tokens）

## 背景和动机

- 现状：项目部署在服务器端后，“图版历史记录/历史图版”功能表现为不更新或失效。
- 目标：取消“历史图版”设置，改为仅持久化最近更新的 5 个图版的最新状态（不足 5 个则全部保存）。
- 约束：保存过程不得造成操作卡顿（绘制/拖拽/缩放时不得出现明显掉帧或阻塞）。

## 关键挑战和分析

- 旧链路清理：已删除历史图版 UI 与存储读写代码，并在 IndexedDB 升级时移除 `history` store，避免残留与误用。
- 存储路径混用风险：`boardsStorage.ts` 同时支持浏览器 IndexedDB 与 Node `fs` 写盘（`src/services/boardsStorage.ts:5`）。在不同部署形态下可能出现“服务端磁盘写入不可用/权限问题/多用户串数据”的隐患；并且部分部署环境可能禁用 IndexedDB，需做浏览器侧降级。
- 性能风险：保存时需要对图片元素做 `slim`（写入 images store / 文件）与 JSON 序列化，若在高频操作的同步路径执行会造成卡顿。
- UX 改造：历史图版入口已从图版面板移除，图版管理仅展示当前图版列表。

## 成功标准

- 存储行为：任何图版发生有效变更后，最终落盘的会话数据只包含“最近更新的 5 个图版”的最新状态；若不足 5 个则全部保存。
- 性能体验：高频交互（拖拽移动、画笔绘制、连续缩放）无明显卡顿；保存操作在空闲/防抖窗口中进行。
- 稳定性：刷新页面/重新打开后，能恢复最近 5 个图版的最新状态，且图版元素（含图片）可正确还原。
- 回归：撤销/重做、图版切换、复制/删除图版等核心流程行为不被破坏。

## 高层任务拆分

1. 定义“最近更新”口径并落地到数据模型
   - 为 `Board` 增加 `updatedAt`（或同等字段）用于标记最后更新时间。
   - 明确哪些操作会更新 `updatedAt`：元素变更、背景色/缩放/平移等是否计入。

2. 实现“只保存最近 5 个图版”的持久化策略
   - 保存前按 `updatedAt`（或替代策略）排序并裁剪到 5 个。
   - 仅对裁剪后的图版执行 `slim` 以降低 IO 与序列化成本。

3. 将保存从“标记变更”升级为“防抖 + 空闲落盘”
   - 统一把 `touchLastSessionPending()` 的调用链改为触发 `saveLastSessionDebounced()`。
   - 保障保存不在用户同步操作链路执行；必要时加并发保护与队列合并。

4. 取消“历史图版”功能与 UI
   - 移除/隐藏 `HistoryList` 入口与相关存储读写（`getHistoryBoards/updateHistoryThumbnail/pushHistoryBoard/pruneHistory`）。
   - 若需要替代入口，改为展示“最近 5 个图版”而非“历史图版”。

5. 验证与压测
   - 功能验证：保存、恢复、图版增删改、图片元素落盘与恢复。
   - 性能验证：高频操作期间 CPU 与主线程阻塞不明显，保存触发频率可控。

## 项目状态看板

### 已完成
- [x] 增加 `updatedAt` 并统一更新触发点
- [x] 保存逻辑裁剪为“最近 5 个图版”
- [x] 接入防抖+空闲落盘，避免主线程卡顿
- [x] 移除“历史图版”入口 UI 与启动阶段历史存储调用
- [x] 移除历史图版残留代码与存储路径（含 IndexedDB `history` store 清理）
- [x] 运行 lint/typecheck/build 并记录结果

### 进行中
- [ ] 手工回归验证与体验确认

### 待办
- [ ] 高频操作压测（连续绘制/拖拽/缩放）与保存频率确认

## 回滚方案

- 代码回滚：通过版本控制回退相关变更，恢复历史图版相关文件与存储逻辑。
- UI 回滚：通过版本控制回退图版面板的 UI 改动。
- 数据兼容：读取会话数据时同时兼容无 `updatedAt` 的旧数据，默认按现有顺序/时间戳回退。
- 发布回滚：构建产物回退到上一版本即可恢复旧行为（不做破坏性迁移）。

## 执行者反馈或请求帮助（占位）

- 执行者每完成一个待办项，更新“项目状态看板”的勾选状态，并记录：改动点、验证结果、潜在风险。

### 当前状态/进度跟踪

- 已完成：`updatedAt` 打点、只保存最近 5 个图版、防抖+空闲落盘、移除历史入口与历史存储链路（含 IndexedDB 升级移除 `history` store）、修复部署环境 IndexedDB 不可用时的会话保存（降级到 localStorage）。
- 校验结果：`npm run lint`（通过）、`npx tsc -p tsconfig.json --noEmit`（通过）、`npm run build`（通过）。
- 预览地址：`http://localhost:3001/`

### 验证指引（人工）

- 连续绘制/拖拽 30 秒：观察是否卡顿；停止操作后 1–3 秒内应完成一次保存。
- 新建 ≥6 个图版并逐个修改：刷新后只恢复最近更新的 5 个。
- 图片元素：导入图片→刷新→图片仍可显示（验证 `slim/inflate` 链路）。

### 请求帮助

- 若目标部署环境禁用 IndexedDB（例如隐私模式/策略限制），请确认 localStorage 是否可用且容量足够；如仍失败，需进一步增加“仅内存会话”或“后端存储”方案。
