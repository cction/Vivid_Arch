# 项目：BananaArch - 图片大小限制与快捷提示词优化

## 背景和动机
用户希望优化图片上传和提示词输入体验：
1.  **图片大小限制**：上传图片到服务器编辑时，长边不大于 2560px（原为 2048px）。
2.  **最近使用提示词**：在快捷效果窗口增加“最近使用”列表，保存最近 5 次不同内容的提示词。

新增安全与兼容性要求：
3.  **API 图片上行限制**：发送至 API 服务器的图片分辨率不得大于 2K（长边 ≤ 2048）。本地图片过大时需自动后台缩放后再发送。
4.  **错误信息脱敏**：项目中所有报错信息需屏蔽 Gemini、banana、WHATAI/Grsai等关键词，避免泄露模型和api信息。

## 关键挑战和分析
-   **图片 Resize**：需要在图片导入的所有入口（单图、多图、粘贴）统一修改 resize 逻辑。
-   **最近提示词存储**：需要持久化存储，且要在 UI 上合理展示（去重、数量限制）。
-   **模块化**：为了便于维护，应将最近提示词逻辑封装为 Hook。
-   **上行图片 2K 约束落点**：与画布内部尺寸是两条链路，必须在“发请求前”统一压缩，避免漏网（WHATAI/Grsai、多图、mask 等）。
-   **上行图片与 Mask 的像素对齐**：缩放原图的同时必须等比缩放 Mask，确保完全同尺寸同坐标系，避免编辑区域错位。
-   **透明度与格式兼容**：缩放 PNG 必须保留 Alpha；避免把透明背景变黑或边缘锯齿化；输出 mime 与编码一致。
-   **EXIF/方向与长宽比一致性**：若存在方向信息，需确保缩放后的图像方向正确且不拉伸变形。
-   **性能与内存**：多图/高分辨率缩放要避免主线程长时间卡顿与内存峰值过高，必要时采用异步/分段处理策略。
-   **错误信息全局脱敏**：区分“用户可见文案/Toast/返回 textResponse/抛出错误”与“开发调试日志”，对用户可见链路做集中替换并加回归约束。
-   **脱敏避免误伤**：脱敏要覆盖大小写与变体（banana/bananna 等）与链接形态，同时避免把普通单词误替换导致可读性崩坏。

## 高层任务拆分
1.  [x] 修改 `src/hooks/useDragImport.ts`，将图片 resize 上限从 2048 改为 2560。
2.  [x] 创建 `src/hooks/useRecentPrompts.ts`，实现最近提示词的存储和管理逻辑。
3.  [x] 更新 `src/i18n/translations.ts`，添加相关文案。
4.  [x] 修改 `src/features/prompt/QuickPrompts.tsx`，展示最近提示词列表。
 5.  [x] 修改 `src/features/prompt/PromptBar.tsx`，在生成时记录提示词。
 6.  [ ] 统一“发送至 API 的图片”预处理（2K 上限），并接入所有发请求路径。
     -   **风险规避与优化**：
         -   **Mask 同步**：当原图被缩放时，若存在 Mask（蒙版），必须以完全相同的比例和尺寸进行缩放，确保像素级对齐。
         -   **透明度保护**：缩放 PNG 格式图片时，必须保留 Alpha 通道，防止透明背景变黑。
         -   **长边判定与方向一致**：按渲染后的实际宽高判断长边并等比缩放，保证不拉伸不变形。
         -   **多图一致性**：同一请求中多图分别独立缩放，且每张都满足长边 ≤ 2048。
         -   **可追踪性（调试信息）**：在开发调试日志中记录“原尺寸→缩放后尺寸、mime、是否含 alpha、是否含 mask”，但不把这些细节暴露给用户提示。
     -   成功标准：
         -   任意输入图片（含 >2K）在请求体中均被缩放到长边 ≤ 2048。
         -   若存在 Mask，Mask 与图像始终同尺寸同坐标系。
         -   不影响画布内部显示与导入尺寸逻辑。
         -   多图/遮罩/不同 provider 均覆盖。
         -   lint/typecheck 通过。
 7.  [ ] 统一错误信息脱敏策略，清理用户可见的模型关键词。
     -   **风险规避与优化**：
         -   **全链路脱敏**：建立统一的 `sanitizeErrorMessage` 工具函数，并在 API Service 的 catch 块、UI Toast 显示处强制调用，确保无死角覆盖。
         -   **关键词规则集中管理**：关键词/正则集中在单处维护，支持大小写不敏感与常见变体（banana/bananna、gemini、nano-banana、WHATAI、Grsai等）。
         -   **避免二次泄露**：不仅处理 `error.message`，也处理服务端返回体中的 message、UI 文案拼接、以及可能包含模型名的链接片段。
         -   **降级文案策略**：当原始错误为空或脱敏后过短时，回退到通用错误提示，保证可读性与可行动性。
         -   **回归约束**：增加覆盖性测试用例，确保任何用户可见错误文本不包含敏感关键词。
     -   成功标准：
         -   UI/Toast/返回文案/抛出错误信息中不包含 Gemini、banana/bananna、nano-banana、WHATAI、Grsai等敏感关键词。
         -   允许在开发调试日志保留更完整错误上下文，但不向用户展示模型/供应商信息。
         -   lint/typecheck 通过。

## 项目状态看板
- [x] 图片 Resize 逻辑更新 (2560px)
- [x] 最近提示词 Hook (`useRecentPrompts`)
- [x] i18n 文案更新
- [x] QuickPrompts UI 更新
- [x] PromptBar 集成
- [ ] API 上行图片自动缩放到 2K
  - [ ] 增加统一的“上行图片预处理”工具函数
  - [ ] 覆盖 Gemini 请求链路的图片与 mask
  - [ ] 覆盖 WHATAI/Grsai 请求链路的图片与 mask
  - [ ] 覆盖多图与不同 mime（jpeg/png/webp）
  - [ ] 增加尺寸缩放的调试日志（不暴露给用户）
  - [ ] 增加测试用例（>2K、含 alpha、含 mask、多图）
- [ ] 报错信息全局脱敏（屏蔽 Gemini/banana/bananna）
  - [ ] 增加 `sanitizeErrorMessage` 工具函数并集中管理规则
  - [ ] 接入所有 API Service 的异常处理与返回文案
  - [ ] 接入 UI Toast/弹窗等用户可见提示链路
  - [ ] 全局搜索并清理硬编码敏感关键词的用户文案
  - [ ] 增加测试用例（大小写、变体、URL/链接形态）
  - [ ] 保留开发调试日志但不向用户暴露模型信息

## 执行者反馈或请求帮助
-   所有功能已实现。
-   已验证 `useDragImport.ts` 中所有 `resizeBase64ToMax` 和 `resizeBlobToMax` 调用均已更新为 2560。
-   已验证 `QuickPrompts` 正确接收并渲染 `recentPrompts`。
-   已新增上行图片预处理工具 `src/utils/uplinkPreprocess.ts`（长边 ≤ 2048，Mask 等尺寸缩放，含调试日志），待接入各 provider 请求链路。

规划者补充：
-   下一步进入执行者模式后，优先处理“API 上行 2K”与“错误脱敏”两项安全需求。
