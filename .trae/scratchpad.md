# BananaPod 项目状态记录

## 新阶段：香蕉按钮工作台界面重设计（规划中）

### 背景和动机

- 现状：香蕉按钮目前仅弹出小型天气预设卡片菜单，承载能力有限，无法将“提示词生成/收集（外部网页）”与“PromptBar 编辑/生成”形成一体化工作流。
- 用户目标（体验）：
  - 点击香蕉按钮后出现一个“尽可能大”的固定尺寸工作台框，左侧为天气预设竖向列表，右侧上方嵌入网页 `https://p.vividai.com.cn/`，右侧下方复用现有 PromptBar（保留全部功能与布局）。
  - 网页内点击“复制”按钮后，提示词自动填入 PromptBar；提示词较多时按现有 PromptBar 展开逻辑向上展开，挤压网页空间，但整体工作台框大小不变化。
  - 保持现有 `src/styles` 与 `src/ui` 的 PodUI 风格一致，不影响其它功能模块。

### 关键挑战和分析

- 跨域 iframe 的交互限制（核心可行性风险）：
  - 应用无法直接读取/监听 iframe 内部 DOM 或按钮点击（同源策略）。
  - 仅依赖剪贴板读取实现“自动填入”在浏览器中通常不可行（权限与用户手势限制），且稳定性差。
- 嵌入限制风险（CSP/X-Frame-Options）：
  - 目标站点可能通过 `frame-ancestors` 或 `X-Frame-Options` 禁止被 iframe 嵌入，导致右上方“网页区域”无法显示。**必须作为前置验证项（Task 0）**。
- PromptBar 状态同步与单一数据源（关键体验）：
  - 工作台内的 PromptBar 与主界面的 PromptBar 必须共享同一份状态（prompt text, attachments）。
  - **防止数据丢失**：用户在工作台输入内容后误触关闭，内容应保留在主界面 PromptBar 中；反之亦然。这要求将 PromptBar 的状态提升（Lift State Up）至 `App.tsx` 或全局 Context。
- PromptBar 展开与布局挤压（体验一致性）：
  - 需要复用现有 PromptBar 的展开/收起与文本框高度控制逻辑，不在工作台中重写，避免回归风险。
  - 工作台整体尺寸固定，但右上 iframe 区域需随 PromptBar 高度动态缩放且不溢出。
- 模块化与不影响现有功能：
  - PromptBar 当前内部持有 `isExpanded` 等 UI 状态；若粗暴外提可能牵涉大量重构。
  - 必须保证不打开工作台时，原 PromptBar 交互、生成、菜单 portal、画布交互不受影响。
- 安全与可控：
  - 外部网页通过消息通信注入提示词属于输入通道，需要严格校验来源与内容长度，避免被其它页面恶意 postMessage 注入。

### 目标定义（可验收）

- 交互与布局：
  - 点击香蕉按钮打开工作台；工作台为固定尺寸的大框（不随 PromptBar 展开改变外框尺寸）。
  - 工作台三分区：
    - 左：天气预设竖向列表（复用 `bananaCards` 数据），**增加顶部微型搜索框**，允许更紧凑以让出网页视野。
    - 右上：iframe 显示 `https://p.vividai.com.cn/`（第一优先级区域）。**增加 iframe 加载中（Loading Skeleton）与加载失败的明确反馈 UI**。
    - 右下：复用现有 PromptBar 的界面与全部功能（长 prompt 时向上展开并挤压 iframe）。
  - 布局比例（网页优先，默认值可调）：
    - 外框尺寸：`width: min(96vw, 1440px)`；`height: min(90vh, 860px)`；保持固定，不随内部内容增高而改变。
    - 左侧预设列：默认 200px；`min 160px / max 240px`；可折叠为 56px（仅图标/缩写），折叠时网页区域获得最大空间。
    - 右侧列：占剩余宽度；内部上下结构：
      - iframe 区域：`flex: 1; min-height: 240px; overflow: hidden`，始终优先保留可视高度。
      - PromptBar 区域：`flex: none`，其自身展开增高时只挤压 iframe，不改变外框尺寸。
- 状态管理与数据安全：
  - **单一数据源**：`App.tsx` 持有 `prompt` 和 `setPrompt`，同时传递给主界面和工作台的 PromptBar。
  - **误操作保护**：关闭工作台（点击遮罩或 ESC）时，不销毁 Prompt 数据，用户可无缝在主界面继续编辑。
- 联动：
  - 点击左侧天气预设：PromptBar 自动填入对应提示词并展开（不自动触发生成）。
  - 网页内复制按钮触发：提示词自动填入 PromptBar 并展开；长文本导致 PromptBar 增高时，挤压右上 iframe 可视区域，但外框尺寸不变。
- 风格一致与快捷键：
  - 工作台容器与分区视觉使用 PodUI 既有样式体系。
  - 支持 **ESC 键关闭工作台**。
- 不影响其它功能：
  - 不打开工作台时，原有 PromptBar/画布/图层/设置/生成流程行为完全一致。

### 方案可靠性论证与风险规避

- 可靠消息通道（推荐方案：站点配合 postMessage）：
  - 需要 `p.vividai.com.cn` 在用户点击“复制”按钮时，同时向父窗口发送消息：
    - `window.parent.postMessage({ type: 'VIVIDAI_PROMPT', prompt: '...' }, '*')`（或指定父域）
  - 应用侧只接受来自 `https://p.vividai.com.cn` 的消息：
    - 校验 `event.origin === 'https://p.vividai.com.cn'`
    - 校验 payload 结构（type/prompt 字段）与长度上限（例如 20k 字符）以及类型为 string
    - 通过统一入口 `setPrompt(prompt)` 写入并触发展开
  - 该方案不依赖剪贴板权限、也不需要跨域 DOM 访问，符合浏览器安全模型，稳定性最高。
- iframe 嵌入可用性预检与降级：
  - 预检：在开发环境先验证 `https://p.vividai.com.cn/` 是否允许 iframe 嵌入（若被阻止则 iframe 区域无法展示）。
  - 降级 A（无需站点配合）：工作台右上区域改为“打开网页”按钮（新标签页），工作台底部提供“从剪贴板粘贴到 PromptBar”按钮（需要用户额外点击一次）。
  - 降级 B（需要较多工程与安全评审）：同域反向代理 + 注入脚本（可能涉及合规与维护成本，不作为首选）。
- PromptBar 展开挤压 iframe 的可靠实现路径：
  - 不重写 PromptBar 的高度/展开算法，仅通过容器布局让其“自然挤压”：
    - 右侧容器 `display:flex; flex-direction:column; height:100%`
    - iframe 容器 `flex:1; min-height:0; overflow:hidden`
    - PromptBar 容器 `flex:none`
  - 触发展开使用最小侵入接口：
    - 通过新增 `expandRequestKey`（递增数字）或 `requestExpand()` 回调，让 PromptBar 内部 `useEffect` 触发 `setIsExpanded(true)`，避免将 `isExpanded` 全量外提造成大范围改动。
- 网页优先的布局稳定性与响应式规避：
  - 左侧预设列采用“紧凑+可折叠”策略，确保在 1366 宽度及以下仍可给 iframe 保留足够宽度。
  - iframe 容器设置 `min-height` 与 `min-width`，避免 PromptBar 展开导致网页区过小不可用；必要时在极窄窗口下自动切换为“折叠左侧预设列”。
  - 预设列表项由“卡牌”调整为“紧凑 list item”（缩略图/图标 + 名称），降低单项高度，减少滚动占用，提高网页区域可视占比。
- 安全边界：
  - 严格 origin 校验：只接受 `https://p.vividai.com.cn`。
  - 只写入 prompt 文本，不执行任何脚本，不解析 HTML。
  - 记录调试信息但不包含敏感数据（不记录用户密钥/令牌，不打出完整 prompt，必要时只记录长度与摘要）。

### 高层任务拆分（规划者 → 执行者实施顺序）

0. **前置验证（Task 0）** [已完成]
   - 验证 `https://p.vividai.com.cn/` 的 iframe 嵌入可行性（X-Frame-Options/CSP）。
   - **结果**：验证通过。响应头包含 `Content-Security-Policy: frame-ancestors *`，允许任意来源嵌入。无 `X-Frame-Options` 限制。

1. 新增工作台 Dialog 与布局骨架（不接 iframe 通信）
   - 新增 `BananaWorkspaceDialog`（三分区布局 + 固定尺寸 + 关闭逻辑 + **ESC 支持**）。
   - 左侧天气列表：**实现搜索框**，复用数据，支持折叠。
   - 右上 iframe 区域：**实现 Loading 状态与加载失败 UI**。
   - 右下 PromptBar 占位。
   - 成功标准：UI 骨架完整，响应式行为（折叠/展开）符合预期。

2. 连接香蕉按钮触发与 App 状态（**状态提升重构**）
   - 在 `App.tsx` 引入 `isBananaWorkspaceOpen` 状态。
   - **关键**：将 PromptBar 的 `prompt` 状态提升至 `App.tsx`，确保主界面与工作台共享同一份数据（避免关闭丢失）。
   - 成功标准：在工作台输入内容，关闭后主界面 PromptBar 保留内容。

3. 实现“天气预设 → PromptBar”联动与展开请求
   - 点击左侧列表项后：`setPrompt(value)` 并触发展开。
   - 成功标准：点击预设，PromptBar 立即展示完整文本并进入展开态。

4. iframe 嵌入与消息桥（postMessage）
   - 右上区域嵌入 iframe：默认指向 `https://p.vividai.com.cn/`。
   - 应用侧监听 `message`，完成 origin + payload 校验后写入 PromptBar。
   - 成功标准：站点发送 `VIVIDAI_PROMPT` 后，PromptBar 自动填入并展开。

5. 降级策略与空状态体验
   - 若 iframe 被阻止或长时间加载失败：展示“打开网页/复制粘贴”降级 UI。
   - 成功标准：即使无法 iframe 嵌入，用户仍可完成提示词导入到 PromptBar 的主流程。

6. 回归验证与性能边界
   - 手动验证：不打开工作台时所有功能不变；打开时 iframe 挤压与 PromptBar 展开行为符合预期。
   - 验证：快捷键是否冲突，Tab 键焦点循环是否正常。
   - 命令验证：`npm run lint`, `npx tsc --noEmit`。
   - 调试信息要求：`[VividAI] message { origin, type, promptLength }`。

### 项目状态看板（香蕉按钮工作台界面重设计）

#### 已完成

- [x] 规划者：确认 postMessage 方案与 iframe 可嵌入性
- [x] 执行者：新增工作台 Dialog 三分区布局骨架 (Task 1)
- [x] 执行者：连接 App 状态与香蕉按钮触发入口（Task 2）
- [x] 执行者：实现预设列表与 PromptBar 联动展开（Task 3）
- [x] 执行者：实现 iframe 与 postMessage 安全消息桥 (Task 4)
- [x] 执行者：实现 iframe 不可用时的降级交互 (Task 5)
- [x] 执行者：回归验证并运行 lint/typecheck (Task 6)
- [x] 规划者：项目验收

#### 进行中

#### 待办

### 当前状态/进度跟踪（香蕉按钮工作台界面重设计）

- 规划者：
  - 状态：所有任务已完成。项目验收通过。
  - 下一步：无。项目结束。
- 执行者：
  - 状态：所有代码已提交并验证通过（lint/tsc Clean）。
  - 下一步：建议用户进行最终手动测试。

## 新阶段：天气预设标签化与提示词拼装（规划中）

### 背景和动机

- 现状：选择天气预设后会把预设 value 直接写入 Prompt 输入框，导致用户看见的是一大段提示词文本，干扰了用户对自己输入的聚焦。
- 用户目标（体验）：
  - **核心诉求：隐藏预设词**。选择天气预设后，输入框内仅显示一个干净的标签（如“晴天”），底层的复杂提示词对用户不可见。
  - 后端生成时，自动将“标签对应的预设词”与“用户输入文本”拼装。
  - 即使用户没有输入任何文本，只要选择了预设标签，也可以点击生成并生效。
- 补充需求（2026-01-08）：
  - 工作台左侧预设列表：**未选中时缩略图保持彩色显示**（不要灰度/黑白效果）。
  - 预设标签展示：标签直接显示在输入框区域，且**强制单选**；点击其他预设为“切换标签”，并清理旧的多选/残留逻辑。

### 关键挑战和分析

- 单一数据源与拼装边界（核心）：
  - 需要区分“用户可见可编辑的文本 prompt”和“不可见但参与生成的预设提示词”。
  - 生成管线（`useGenerationPipeline`）当前只接收一个 `prompt: string`，因此必须在进入管线前完成拼装（`effectivePrompt`）。
- UI 嵌入标签的布局风险：
  - PromptBar 目前用 `Textarea` + 动态 padding 控制视觉与高度，需要在不破坏现有展开/收起逻辑的前提下把标签行“嵌入输入区”。
  - 标签行存在横向溢出与换行两种策略；需要避免导致文本框高度抖动或 portal 菜单遮挡异常。
- 交互一致性与回归范围：
  - 预设入口仅保留工作台左侧列表（`BananaWorkspaceDialog`），主界面/PromptBar 不再提供预设入口；PromptBar 仅保留“打开工作台”的触发按钮。
  - 既要保证“选预设=加标签”，又不能影响 QuickPrompts、用户自定义效果、以及工作台 iframe 同步 prompt 的逻辑。
- 复制行为设计（体验定义，不是风险）：
  - 标签引入的核心是“隐藏预设词”，因此 UI 不应展示预设 value，也不应把 value 写入输入框。
  - 复制输入框文本时，**只复制用户可见文本**，不包含隐藏的预设词（这是设计目的本身）。
- 去重与可组合策略（产品定义风险）：
  - 本阶段明确为**强制单选**：任意时刻最多选中 1 个预设标签。
  - 交互规则：点击未选中预设 => 直接替换当前选中；点击已选中预设 => 取消选中。
- 现有实现迁移（清理残留逻辑风险）：
  - 若代码中已存在多选状态（如 `selectedWeatherIds: string[]`）与其 localStorage 持久化，需要迁移为 `selectedWeatherId: string | null`。
  - 迁移策略：启动时若检测到旧键/旧数组值，仅迁移首项到新键并清除旧键，避免历史残留继续影响交互。
- 工作台左侧缩略图黑白效果来源（视觉风险）：
  - 需要定位当前未选中态是否通过 `filter: grayscale(...)` / `opacity` / `mix-blend-mode` 实现，并移除灰度处理，仅保留边框/背景/透明度等“选中态提示”。
- 语言切换与稳定标识（隐藏风险）：
  - 当前预设是中英两套 `name/value`；如果用户在工作台选择预设后切换语言，标签展示与去重逻辑可能受影响（例如同一预设在不同语言下 name 不同）。
  - 解决方案：为每个预设引入稳定 `id`，状态只存 `id`，展示与拼装在运行时按语言读取对应 `name/value`。
- 长文本与上限策略（稳定性风险）：
  - `effectivePrompt` 可能非常长（预设 value + 用户文本 + iframe 导入文本叠加），需要制定上限策略，避免请求失败与 UI 卡顿。
  - 解决方案：为 `effectivePrompt` 设定最大字符数与行为（阻止生成并提示 / 截断并提示二选一），调试日志仅打印长度摘要不打印全文。
- 焦点与可访问性（易被忽略）：
  - 选择预设后应把焦点带回 Prompt 输入框，保证键盘连续编辑体验。
  - 工作台关闭/打开的焦点回收、ESC 行为、Tab 顺序需回归验证，避免 iframe 抢焦点导致不可操作。
- 生成中交互与一致性（状态机风险）：
  - 生成进行中（isLoading=true）时是否允许增删标签需要明确：允许会让用户误以为“正在进行的任务也会变”；禁用则需在 UI 层明确不可操作。
  - 推荐策略：生成中禁用标签增删与预设选择（对齐现有 PromptBar 禁用输入逻辑），避免状态分叉。
- 作用域定义（多画板/多场景风险）：
  - 当前 App 有多 Board；天气预设标签应该是“全局（随 PromptBar）”还是“按 Board 独立”需要定义，否则用户切换 Board 时会困惑。
  - 推荐策略：与 `prompt` 保持一致的作用域（当前实现是全局 prompt），标签也全局，后续如要按 Board 拆分再做一致性重构。
- 可观测性与调试要求：
  - 需要在生成前输出调试信息，证明 effectivePrompt 的来源与长度组成，但不得输出完整 prompt（避免泄露用户内容）。
- 撤销/重做断层风险（交互一致性）：
  - 浏览器原生撤销（Ctrl+Z）仅作用于 Textarea 文本，不会撤销标签增删，可能导致用户误解。
  - 解决方案：提供显式“清空标签”能力，并保证删除标签的交互足够直观，减少用户依赖 Ctrl+Z。
- 持久化缺失（数据丢失风险）：
  - `selectedWeatherId` 若仅存在内存，刷新页面会导致标签丢失。
  - 解决方案：将 `selectedWeatherId` 持久化到 `localStorage`，并在启动时恢复；必要时提供“清空草稿”入口。
- 列表选中态反馈（视觉闭环）：
  - 工作台左侧列表需要显示选中态（高亮/勾选），与 PromptBar 标签保持同步，避免用户在列表侧“看不到自己已选了什么”。

### 目标定义（可验收）

- 交互：
  - 点击任意天气预设后：输入框文本不变；输入框区域出现对应标签；标签可移除。
  - 任意时刻最多 1 个标签；点击其他预设直接切换为新标签。
  - 用户在输入框内继续输入/删除文本，不影响已选标签。
  - 输入框为空但存在标签：生成按钮可用；回车可触发生成。
- 生成一致性：
  - 发往后端的最终提示词为：`effectivePrompt = selectedPresetValue + join(用户输入文本)`（无标签时 `selectedPresetValue=''`）。
  - 若仅存在标签而无文本：仍可生成，且效果明显体现所选天气氛围。
- 兼容性：
  - QuickPrompts 与“保存为我的效果”仍使用用户可见文本 prompt，不会把天气预设 value 混入保存文本（避免污染用户自定义效果）。
  - 工作台 iframe 写入 prompt（VIVIDAI_PROMPT）仍只影响用户文本输入区，不会意外清空或覆盖天气标签。
  - 复制输入框文本仅包含用户可见文本，不包含隐藏预设词。
- 视觉一致性：
  - 工作台左侧预设列表：未选中状态缩略图仍为彩色；选中态通过边框/背景/对勾等方式强化，不通过灰度区分。

### 方案可靠性论证与风险规避

- 状态模型建议（ID 驱动，确保隐藏）：
  - `App.tsx` 新增 `selectedWeatherId: string | null`（仅存 id，不存 value）。
  - `prompt` 继续作为“用户可见文本”，不包含预设 value。
  - 拼装逻辑：`effectivePrompt = (selectedWeatherId ? getPresetValue(selectedWeatherId, lang) : '') + join(prompt)`，拼装点仅在“生成”路径发生。
- 标签与文本的职责隔离：
  - 标签仅展示 `name`，`value` 不出现在 UI 和输入框中。
  - “保存我的效果”默认仍以 `prompt` 为准，避免把隐藏的系统拼装内容写入用户自定义库。
- 入口改造策略：
  - 工作台预设列表点击改为“切换标签选择”（只改 `selectedWeatherId`），不再写入 `prompt`。
  - PromptBar 仅负责展示标签与用户文本编辑；不在 PromptBar 内部持久化业务状态。
  - BananaSidebar 不作为预设入口，可以考虑在不影响其他功能前提下删除相应功能模块；入口仅保留工作台左侧列表。
- 可观测性（调试信息）：
  - 生成触发点输出：`[PromptBuild] { ids, presetChars, userChars, effectiveChars, policy }`，仅输出长度与 id，不输出完整文本。

### 高层任务拆分（规划者 → 执行者实施顺序）

1. **预设数据稳定化（语言切换风险对策）**
   - 为 `bananaCards` 引入稳定 `id`（同一预设跨语言保持一致）。
   - 提供 `getWeatherPresetById(id, lang)` 之类的统一解析入口（按语言取 name/value）。
   - 成功标准：切换语言后，已选标签不重复、不丢失，展示名称随语言变化。

2. **状态管理与持久化（数据丢失风险对策）**
   - `App.tsx` 引入 `selectedWeatherId`（仅存 id）。
   - 同步 `selectedWeatherId` 到 `localStorage`，启动时恢复；提供“清空标签”能力。
   - 成功标准：刷新页面后标签仍在；用户可一键清空。

3. **拼装与上限策略（长文本风险对策）**
   - 计算 `effectivePrompt`：按 `selectedWeatherId` 映射预设 value + 用户输入 `prompt`。
   - 为 `effectivePrompt` 制定上限策略（阻止生成并提示 / 截断并提示），并在日志中仅输出长度摘要与 id。
   - 成功标准：超长时行为可预期；日志无明文 prompt。

4. **PromptBar 标签 UI（隐藏预设词落地）**
   - 输入框上方或内部容器展示标签 name（Chips UI）；用户输入文本保持独立。
   - 支持删除单个标签与清空全部标签；支持 Backspace 键在输入框为空时删除最后一个标签。
   - 生成中禁用标签增删（状态机风险对策）。
   - 选择/删除标签后焦点回到输入框（可访问性对策）。
   - 成功标准：标签可操作且不泄露预设词；键盘编辑流畅（含 Backspace 删除）。

5. **工作台列表联动（入口与视觉闭环）**
   - 工作台左侧列表点击仅切换 `selectedWeatherId`（不写入 prompt）。
   - 列表项展示选中态（高亮/勾选），生成中禁用点击。
   - 成功标准：列表与标签同步，用户能一眼确认已选状态。

6. **生成入口改造（拼装边界落地）**
   - 生成按钮/回车触发与 disabled 逻辑基于 `effectivePrompt`（允许“仅标签也能生成”）。
   - 修改 `useGenerationPipeline` 的 `Deps` 类型定义，使其明确接收 `effectivePrompt` 而非仅依赖 `prompt`。
   - 成功标准：仅标签也能生成；生成效果体现所选天气氛围；类型定义清晰。

7. **工作台左侧缩略图彩色显示（视觉需求补丁）**
   - 移除未选中状态下的灰度滤镜（如 `filter: grayscale(...)`），保持缩略图彩色。
   - 选中态仍需保留明确视觉提示（边框/背景/勾选/对比度提升），但不使用灰度作为未选中标识。
   - 成功标准：未选中预设缩略图为彩色；选中态可清晰辨识；无其它区域样式回归。

7. **作用域确认与一致性落地（多 Board 风险对策）**
   - 确认天气预设标签的作用域策略（当前为全局，与 prompt 保持一致）。
   - 确保切换 Board 或其他上下文时，标签状态表现符合预期（即保持全局一致或按需重置）。
   - 成功标准：多场景下标签状态表现逻辑自洽。

8. **清理 BananaSidebar 旧代码（入口收敛）**
   - 移除 `BananaSidebar` 作为预设入口的相关代码（如 `PromptBar` 中的引用）。
   - 清理不再使用的 `BananaSidebar` 组件代码或仅保留必要复用部分。
   - 成功标准：代码库无冗余入口逻辑；`BananaSidebar` 不再作为用户可见入口存在。

9. **回归验证与命令验证（覆盖所有风险）**
   - 手动验证：语言切换、刷新持久化、生成中禁用、焦点回收、长文本策略、Board 切换作用域一致性。
   - 命令验证：`npm run lint`、`npx tsc --noEmit`。
   - 成功标准：lint/typecheck clean；核心交互无明显回归。

### 项目状态看板（天气预设标签化与提示词拼装）

#### 已完成

- [x] 规划者：确认交互规则与拼装边界（单选/去重策略）
- [x] 规划者：更新方案以包含 UI 细节、类型定义、作用域与清理任务
- [x] 执行者：为 bananaCards 引入稳定 id 与语言映射 (Task 1)
- [x] 执行者：新增 selectedWeatherIds 状态并实现 localStorage 持久化 (Task 2)
- [x] 执行者：实现 effectivePrompt 拼装与长度上限策略 (Task 3)
- [x] 执行者：PromptBar 增加标签 UI（Chips）、删除交互与 Backspace 支持 (Task 4)
- [x] 执行者：工作台列表支持选中态并切换标签选择 (Task 5)
- [x] 执行者：生成管线使用 effectivePrompt 并明确 Deps 类型定义 (Task 6)
- [x] 执行者：确认 selectedWeatherIds 作用域策略与一致性 (Task 7)
- [x] 执行者：清理 BananaSidebar 旧代码 (Task 8)

#### 进行中

- [ ] （空）

#### 待办

- [ ] （空）

### 当前状态/进度跟踪（天气预设标签化与提示词拼装）

- 规划者：
  - 状态：已根据反馈完善方案（UI 细节、类型定义、清理任务等），并更新任务拆分与看板。
  - 下一步：等待执行者完成 Task 6-9，并根据回归结果调整方案。
- 执行者：
  - 状态：已完成 Task 1-8；生成管线已明确使用 effectivePrompt；切换 Board 会清空标签与文本保持一致；BananaSidebar 旧入口已移除（PromptBar 改为仅保留“打开工作台”按钮）。
  - 下一步：等待规划者验收；需要的话继续做 UI 微调与体验打磨。
  - 验证办法（手动）：
    - 选择“晴天/雨天”：输入框文本不变，出现标签；再次点击同一预设应移除标签（默认策略）。
    - 清空文本但保留标签：生成按钮可点；生成结果体现对应天气氛围。
    - 同时操作 QuickPrompts、保存我的效果：保存内容不包含天气预设 value。
    - 在工作台与主界面来回切换：标签与文本状态保持一致，不丢失、不串扰。
    - 语言切换（ZH/EN）：标签展示应随语言变化且不出现重复；去重逻辑按同一预设生效。
    - 极端长文本：导入/输入超长文本后 UI 不崩溃，生成策略符合预期（截断/提示/阻止其一）。
    - 生成中操作：生成进行中尝试选择预设/移除标签，行为符合定义（推荐：不可操作且 UI 有禁用态）。
    - 切换 Board：切换前后标签与 prompt 的作用域行为一致，不出现“丢失/串扰”。
  - 验证办法（日志/调试）：
    - 生成前应输出 `[PromptBuild]`，仅包含计数与长度摘要，不包含完整 prompt。
  - 验证办法（命令）：
    - `npm run lint`
    - `npx tsc --noEmit`
  - 命令结果（最近一次）：
    - lint: exit code 0
    - tsc: exit code 0
  - 启动项目（dev）：
    - Local: http://localhost:3001/

## 补充迭代：输入框前缀标签交互与单选切换（规划中）

### 背景和动机

- 现状：标签虽已“显示在输入框区域”，但仍需要更贴近“像文本一样编辑”的交互心智。
- 用户目标（体验）：
  - 标签永远出现在文本前面（不论输入框当前是否有文本）。
  - 标签可像文本一样被“输入/删除逻辑”操作：用户无需清空文本即可通过键盘删除标签。
  - 标签强制单选：点击其他预设为切换；点击已选预设为取消。
  - 工作台左侧预设缩略图未选中保持彩色显示（不使用灰度作为未选中反馈）。

### 目标定义（可验收）

- 输入框视觉与布局：
  - 标签与文本处于同一个“输入框容器”内，标签在左侧/前缀位置，文本始终在其后。
  - 当文本换行时，标签仍位于第一行开头，文本从标签后开始自然排布。
- 键盘编辑一致性（核心）：
  - 光标位于文本最左侧（等价于 `selectionStart === 0 && selectionEnd === 0`）时：
    - `Backspace` 删除标签（若存在），不影响文本内容；文本不为空也生效。
    - `Delete` 删除标签（若存在），不影响文本内容；文本不为空也生效。
  - `Enter` 生成逻辑保持一致（遵循现有“Enter 生成 / Shift+Enter 换行”规则）。
- 鼠标与焦点：
  - 点击标签可移除；移除后焦点回到输入区。
  - 选择/切换预设后焦点回到输入区，用户可连续键盘输入。
- 预设选择规则：
  - 强制单选：选择新预设立即替换当前标签；再次点击同一预设则取消选中。
- 生成与禁用：
  - 仅标签也可生成；生成中禁用切换/删除标签与预设选择（避免状态分叉）。
- 视觉一致性：
  - 工作台左侧预设列表未选中缩略图为彩色；选中态通过边框/背景/勾选强化即可。

### 关键挑战和分析

- “标签像文本一样删除”的落地方式：
  - 不要求把标签序列化进 prompt 字符串（否则会污染复制/保存效果/撤销语义）。
  - 通过键盘事件在“光标位于文本起始”时把删除动作重定向为“删除标签”，达到用户心智一致。
- “标签永远在文本前面”的布局方式：
  - 需要把标签渲染进输入框容器的前缀区域（而不是单独一行置顶），并保持多行文本时的自然流式排布。
  - 推荐使用同一容器内的前缀 Token + Textarea 并做 flex-wrap/布局约束，避免引入 contenteditable 的复杂选择/撤销问题。

### 方案可靠性论证与风险规避

- 输入框结构建议（稳定、可控）：
  - 用一个“输入框外观容器”包裹：`Chip(可选) + Textarea`，并确保容器本身承担边框/背景/hover/focus 样式。
  - **健壮性改进（布局）**：采用 `absolute` 定位 Chip 于左上角，并动态测量 Chip 宽度赋值给 Textarea 的 `text-indent`。这确保第一行文本自动避让标签，而第二行自然回落，无需复杂的 DOM 拼接或 `contenteditable`，保留原生输入体验。
  - **健壮性改进（测量稳定性）**：用 `ResizeObserver` 监听 Chip 尺寸变化（语言切换/字体加载/窗口缩放），并用 `requestAnimationFrame` 合批更新 `text-indent`，避免频繁 setState 造成抖动。
  - **健壮性改进（降级策略）**：若测量失败（ref 为空/SSR/observer 不可用），降级为“标签置于输入框内左上角但不做缩进”，同时保持功能可用（仅影响视觉不影响输入/生成）。
- 键盘删除语义建议：
  - 在 Textarea 的 `onKeyDown` 中，当光标在起始位置且存在标签时拦截 `Backspace/Delete`，改为清除标签（并 `preventDefault()`）。
  - **健壮性改进（IME）**：必须检查 `e.nativeEvent.isComposing`，防止中文/日文输入法在拼音编辑阶段按下 Backspace 误删标签。
  - **健壮性改进（焦点）**：删除标签后，显式调用 `setSelectionRange(0, 0)` 确保光标停留在头部，防止跳动。
  - **健壮性改进（选择区判定）**：删除标签前先严格判断 `selectionStart === 0 && selectionEnd === 0`，避免用户选中部分文本时误删标签。
  - **健壮性改进（快捷键兼容）**：对 `Ctrl+Backspace` / `Alt+Backspace` 等“按词删除”保持原语义，不应触发删标签（减少用户肌肉记忆冲突）。
- 兼容性与迁移：
  - prompt 文本保持纯用户输入，不掺杂任何预设 value；复制、保存效果、QuickPrompts 不受影响。
  - **健壮性改进（迁移）**：在 `App.tsx` 初始化迁移旧状态时，增加防御性校验（检查 id 是否有效），防止脏数据导致应用崩溃。
  - 生成管线仍使用 effectivePrompt（预设 value + prompt），拼装边界不变。
  - **健壮性改进（回归边界）**：把“前缀标签容器”封装为最小可替换子组件，仅通过 props 影响 Textarea 的 `style/handlers`，避免污染 PromptBar 其它菜单、动画、portal、生成按钮逻辑。

### 高层任务拆分（规划者 → 执行者实施顺序）

1. **单选状态模型迁移与残留清理**
   - 将多选状态（若存在）统一迁移为 `selectedWeatherId: string | null`，清理旧数组逻辑与旧 localStorage key。
   - 迁移时做防御性校验：仅当 id 能在预设表中解析到条目才恢复，否则清空并删除旧键，避免脏数据造成空白标签或异常。
   - 成功标准：代码库无 `selectedWeatherIds` 业务逻辑残留；刷新后状态正确恢复；脏数据不会导致崩溃。
2. **PromptBar 输入框前缀标签布局改造**
   - 将标签从“输入框上方/旁侧区域”调整为“输入框容器内前缀 token”，确保标签永远在文本前。
   - 使用 `absolute` 定位 + 动态测量 Chip 宽度赋值给 Textarea 的 `text-indent`，保证第一行避让、后续行自然回落。
   - 用 `ResizeObserver` 监听 Chip 尺寸变化并用 `requestAnimationFrame` 合批更新缩进，减少抖动与重复渲染。
   - 提供测量失败降级：仍显示标签但不缩进，保证输入与生成逻辑不受影响。
   - 成功标准：文本存在/不存在时标签位置一致；多行文本下布局稳定无抖动；语言切换/字体加载/窗口缩放时缩进正确或优雅降级。
3. **键盘交互：标签像文本一样删除**
   - 在光标位于文本起始且无选择区（`selectionStart === 0 && selectionEnd === 0`）时拦截 `Backspace/Delete` 删除标签（文本不为空也生效），并补齐焦点回收。
   - 输入法保护：当 `e.nativeEvent.isComposing` 时不处理删标签，避免拼音编辑阶段误删。
   - 快捷键兼容：`Ctrl+Backspace` / `Alt+Backspace` 等按词删除保持原语义，不触发删标签。
   - 删除标签后调用 `setSelectionRange(0, 0)`，确保光标位置稳定。
   - 成功标准：无需清空文本即可键盘删除标签；输入法编辑不误删；按词删除不受影响；光标不跳动。
4. **工作台左侧缩略图彩色显示修正**
   - 移除未选中态的灰度滤镜，保留其它选中态提示。
   - 成功标准：未选中缩略图彩色；选中态辨识清晰。
5. **回归验证与命令验证**
   - 覆盖：预设切换/取消、键盘删除、生成禁用、语言切换、Board 切换、工作台与主界面同步。
   - 关键边界用例：
     - 文本非空时光标在 0：`Backspace/Delete` 删标签但不删字。
     - 选中一段文本：`Backspace/Delete` 只删文本不删标签。
     - 输入法拼音编辑中：`Backspace` 不触发删标签。
     - `Ctrl+Backspace/Alt+Backspace`：保持按词删除，不触发删标签。
     - 语言切换/字体加载/缩放：缩进正确或优雅降级，无明显抖动。
   - 成功标准：`npm run lint` 与 `npx tsc --noEmit` 均为 clean；以上边界用例全部通过。

### 项目状态看板（补充迭代：输入框前缀标签交互与单选切换）

#### 已完成

- [x] 规划者：补充需求交互规则与验收标准固化到方案
- [x] 执行者：PromptBar 输入框前缀标签布局改造（text-indent+ResizeObserver+rAF+降级）
- [x] 执行者：工作台左侧缩略图彩色显示修正
- [x] 执行者：单选状态模型迁移与残留清理（旧键清理/脏数据校验）
- [x] 执行者：键盘交互对齐文本删除逻辑（IME/选择区/按词删除/光标稳定）
- [x] 执行者：回归验证并运行 lint/typecheck（覆盖关键边界用例）

#### 进行中

- [ ] （空）

#### 待办

- [ ] （空）

### 当前状态/进度跟踪（补充迭代：输入框前缀标签交互与单选切换）

- [x] **健壮性改进（回归边界）**：把“前缀标签容器”封装为最小可替换子组件 `PromptInputWithPrefixTag`，仅通过 props 影响 Textarea 的 `style/handlers`，避免污染 PromptBar 其它菜单、动画、portal、生成按钮逻辑。
- [x] **样式对齐**：标签大小和单行文本高度对齐，字体大小也和文本对齐，标签样式设计符合当前主界面内UI风格标准设计和样式引用。
- [x] **项目启动与验证**：已通过本地构建、lint、typecheck 与 dev 预览验证交互逻辑，准备进入发布阶段。
- [x] **版本发布**：已按 `update.md` 规范完成 v1.4.1 版本号更新、CHANGELOG/README/metadata/updateFeed 对齐，并生成 release commit 与 tag `v1.4.1`。

### 执行者反馈或请求帮助
- 已完成前缀标签组件封装与样式对齐，并在本地开发环境验证通过。
- 已完成 v1.4.1 发布相关文件更新、构建、lint/tsc 与安全审计（npm audit 受镜像源安全接口未实现影响，返回 NOT_IMPLEMENTED 报错，记录结果后继续发布流程）。
