# BananaPod 项目状态记录


## 当前阶段：生成按钮与生图取消能力改造（规划者）

### 背景和动机

- 现状：当前 PromptBar 底部使用文字按钮触发生图，请求开始后仅通过全局 Loading 提示进度，无法在同一入口执行“取消本次生成”，且按钮文案与图标在不同语言下不一致。
- 症结：
  - 生图过程中，用户如果发现提示词写错，只能等待请求结束或刷新页面，缺乏“立即中断”的控制点。
  - 生成按钮缺少明确的状态切换（空输入/可触发/生成中），交互不直观，视觉上也没有统一的图标化设计。
  - 前端生成管线 `useGenerationPipeline.ts` 为一次性流程，没有显式的“取消信号”或令牌机制，难以在中途停止后续副作用（占位图插入、元素替换等）。
- 目标：设计并实现一个图标化的生成按钮，具备清晰的三态（未激活/可生成/生成中），并在生成过程中支持点击同一按钮取消本次生图，请求结束后不再更新画布或状态。
- 范围：仅涉及前端交互与状态管理，包括 PromptBar 组件、App 容器和 `useGenerationPipeline` 生成管线，不调整服务端 API 行为。

### 关键挑战和分析（本阶段）

- 按钮状态机设计：
  - 需要用最少的状态表达三个维度：输入是否为空、是否在生成中、是否存在可取消的请求。
  - 按钮颜色保持不变，仅依靠图标和启用/禁用态传达含义，避免破坏现有视觉规范。
- 取消语义与实现方式：
  - 后端 API 未必提供硬中断能力，因此前端至少要做到“软取消”：即便请求在后台继续，前端不再消费结果、不更新画布。
  - 需要一个简单可靠的机制（令牌 token / generationId）区分不同批次的生成，确保取消后旧请求的结果不会覆盖新状态。
- 与现有生成管线的兼容性：
  - `useGenerationPipeline.ts` 同时支持文本生图、编辑生成和掩膜重绘，取消机制必须对三种模式统一生效。
  - 要兼顾占位图插入/替换逻辑，避免在取消后仍残留“生成中”占位元素或错误的选中状态。
- 用户体验与键盘操作：
  - 保持 Enter 快捷键仍能触发生图，且在生成中按 Enter 不应再次触发新的请求。
  - 按钮的 aria-label 与 title 需要随着状态切换（生成/取消）以兼顾可访问性。

### 本阶段高层任务拆分

1. 需求澄清与现状盘点
   - 梳理当前 PromptBar 中生成按钮的渲染逻辑、文案来源以及启用/禁用条件。
   - 盘点 `App.tsx` 与 `useGenerationPipeline.ts` 中关于 `isLoading`、错误提示和占位符的状态流转。

2. 设计按钮状态机与图标方案
   - 定义按钮三态：
     - 未激活：输入为空，按钮禁用，仍展示统一背景色。
     - 可生成：输入非空，显示向上箭头图标，点击触发生图。
     - 生成中：显示暂停/停止图标，点击触发取消。
   - 明确 aria-label/title 文案切换规则，保证中英文下行为一致。

3. 生成管线取消机制设计
   - 选择令牌模式：为每次生成分配递增 token，保存在 `useRef` 中。
   - 设计 `handleCancelGenerate` 接口：将当前 token 作废并清理 `isLoading` 与进度提示。
   - 在管线内所有异步结果落地前检查 token，一旦不匹配则直接丢弃结果。

4. 前端接线与实现方案
   - 在 `useGenerationPipeline.ts` 中实现 token + 取消逻辑，并返回 `{ handleGenerate, handleCancelGenerate }`。
   - 在 `App.tsx` 中接入新的取消函数，将 `isLoading` 与按钮状态关联起来。
   - 在 `PromptBar.tsx` 中重构生成按钮为图标按钮，拆分点击逻辑（生成 / 取消）。

5. 测试与验证策略
   - 手动场景：空输入、正常生图、中途取消、取消后立即重新生成、连续多次生成等。
   - 异常注入：结合 `localStorage('debug.gen.fail')` 模式，验证取消后不会出现“卡在生成中”的假状态。
   - 回归检查：确认不影响占位符插入与替换、图层选中行为以及键盘快捷键。

### 项目状态看板（生成按钮与取消能力）

#### 已完成

- [x] 规划者：整理生成按钮与取消能力的背景、问题与目标（本文件）。
- [x] 规划者：给出按钮三态与生成管线取消机制的高层方案。

#### 进行中

- [ ] 设计并执行手动测试用例，覆盖正常流程与各类异常/取消场景。
- [ ] 根据测试结果微调按钮交互与错误提示文案。

#### 待办

- [x] 在 `PromptBar.tsx` 中重构生成按钮为图标按钮（向上箭头 / 停止）。
- [x] 在 `useGenerationPipeline.ts` 中实现 token 驱动的取消逻辑，并导出 `handleCancelGenerate`。
- [x] 在 `App.tsx` 中将取消函数接入 PromptBar，并统一管理 `isLoading` 与按钮状态。

### 执行者反馈或请求帮助（本阶段约定）

- 执行者在开始实现前，应从“待办”中选中一个任务，将其拆分为 1–3 个可执行的小步骤，并在本节补充：
  - 涉及的文件与核心改动点。
  - 可能的风险（如对现有占位符逻辑的影响、与键盘快捷键冲突等）。
- 实现完成后，执行者需要：
  - 更新“项目状态看板（生成按钮与取消能力）”中对应条目为已完成。
  - 在本节记录：实际改动摘要、运行过的命令（如 `npm run lint`、`npx tsc --noEmit`）以及手动测试结论。
  - 若发现现有生成管线结构不利于引入取消机制，应在此提出重构建议由规划者评估。

### 当前状态/进度跟踪（生成按钮与取消能力）

- 规划者：
  - 已完成生成按钮三态与取消交互的整体设计，明确了状态机、图标方案以及与生成管线的边界。
  - 已将实现工作拆分为 PromptBar UI 重构、生成管线取消机制、App 接线与测试三个主要方向，并落入看板待办。
- 执行者（本轮实现）：
-  - 已在 `PromptBar.tsx` 中将文字生成按钮重构为三态图标按钮：空输入禁用、可生成时显示向上箭头、生图过程中显示圆圈 + 方块停止图标，并通过同一入口触发生成 / 取消。
-  - 已在 `useGenerationPipeline.ts` 中引入基于 `useRef` 的递增 token 机制，封装 `safeSetIsLoading/safeSetError/safeCommitAction/safeSetSelectedElementIds` 等方法，并在所有异步回调和占位符替换逻辑前检查 token，确保取消后旧请求不会继续修改画布或状态，同时导出 `handleCancelGenerate`。
-  - 已在 `App.tsx` 中接入新的 `handleCancelGenerate`，并将其传递给 `PromptBar`，使主生成按钮具备取消当前生图的能力；同时保持原有 `isLoading` 与 Loader 行为不变。
-  - 已运行 `npm run lint` 与 `npx tsc --noEmit`，当前无新增 lint 或类型错误。
