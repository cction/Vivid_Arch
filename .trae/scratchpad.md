# BananaPod 项目状态记录


## 当前阶段：生图链路与占位符体验优化（规划者）

### 背景和动机

- 现状：当前生图链路已经支持 Nano Banana（Gemini 2.5 Flash Image）与 Nano Banana Pro（Gemini 3 Pro Image 预览版），前端根据模型和宽高比发起文本转图片/图片编辑请求，但占位符体验较为粗糙，尺寸仅基于“长边 + 比例”粗略估算。
- 症结：占位符尺寸与实际返回图片尺寸存在偏差，生成完成瞬间图片会“跳动”；不同模型（Flash/Pro）在同一宽高比下实际像素不同，且 Pro 模型支持 1K/2K/4K 多档分辨率，现有逻辑未精确对齐官方表格。
- 目标：在不改变现有业务能力的前提下，重新设计并实现“生图链路 + 占位符”整体方案，使占位框尺寸与最终图片尺寸严格一致，并在生成过程中提供清晰的加载反馈（中心转圈），覆盖文本生图、编辑生成和掩膜重绘等模式。
- 范围：仅涉及前端生图链路相关代码与交互（包含尺寸推导、占位符插入与替换、错误处理、Canvas 渲染），不调整后端 API 行为、不改变现有模型和宽高比配置的业务含义。

### 关键挑战和分析（本阶段）

- 多模型尺寸差异：Nano Banana Pro 与 Nano Banana 在同一宽高比下的官方推荐像素不同，且 Pro 模型还区分 1K/2K/4K 三档，需要精确维护尺寸映射表并与 UI 的 `imageModel/imageSize/imageAspectRatio` 状态保持一致。
- 占位符与真实图片对齐：占位符尺寸应与最终图片像素完全匹配，否则生成完成后会发生视觉跳变；同时需要考虑画布缩放与居中逻辑，使生成中的占位框位置合理且可预期。
- 多模式统一：文本生图、基于选区的编辑生成、掩膜重绘三种模式在“放置位置”“是否新建元素”“是否使用占位图”上存在差异，需要统一抽象一套占位策略而不破坏现有交互。
- 错误与中断处理：请求失败或图片加载失败时，必须确保占位元素能被正确清理（或恢复到原状态），避免画布上残留“转圈中”的假象。
- 性能与可维护性：尺寸映射表、占位逻辑和渲染层改动需要结构清晰，避免将大量分支逻辑塞入单一 Hook/组件，保证后续可以方便扩展新的尺寸/宽高比。

### 本阶段高层任务拆分

1. 梳理现有生图链路与模式划分
   - 明确文本生图、编辑生成、掩膜重绘在 `useGenerationPipeline.ts` 中的调用路径和当前尺寸/位置计算逻辑。
   - 标记出模型选择（Nano Banana / Pro）与前端尺寸参数（imageSize/imageAspectRatio）的来源与约束。

2. 设计官方尺寸映射与占位符尺寸推导方案
   - 从 Gemini 文档整理 Nano Banana Pro（Gemini 3 Pro Image）和 Nano Banana（Gemini 2.5 Flash Image）的宽高比 → 像素表。
   - 定义统一的尺寸查询接口：输入模型、宽高比、尺寸档位（1K/2K/4K），输出占位符宽高，确保与官方表格一致。

3. 设计占位符插入与替换策略（数据层）
   - 在 `ImageElement` 中扩展用于表示“生成中”状态的字段（例如 `isGenerating`），确保不会影响现有静态图片行为。
   - 为三个模式分别明确：是否新建图片元素、占位符插入位置（居中 / 选区右侧 / 原图覆盖）、何时替换或清理。

4. 设计 Canvas 渲染层的占位与加载反馈
   - 在 `Canvas` 组件的 `image` 渲染分支中，定义当 `isGenerating` 为真时的叠加视觉：中心旋转圆圈 + 占位底纹。
   - 保证在不同 zoom 下转圈粗细和尺寸表现合理，并与现有按钮上的 loading 风格尽量一致。

5. 实现与集成新的生图链路逻辑
   - 在 `useGenerationPipeline.ts` 中接入尺寸映射表与占位符流程：请求前插入占位，成功后替换为真实图片，失败时清理。
   - 覆盖文本生图、编辑生成、掩膜重绘三种模式，确保对已有调用方透明。

6. 验证与调优
   - 设计多种组合场景：不同模型、宽高比和尺寸档位，以及不同画布缩放与选区情况，检查占位与真实图片是否尺寸一致、位置合理。
   - 对错误场景（网络失败、图片加载异常）进行注入测试，确认占位元素不会残留“假加载”状态。

### 项目状态看板（生图链路与占位符优化）

#### 已完成

- [x] 在 Canvas 渲染层优化占位符样式：
  - 使用 `foreignObject` 替换简单的 SVG `rect`。
  - 引入 Glassmorphism 风格（背景模糊、半透明、边框），对齐 `src/ui` 设计语言。
  - 优化 Loading 状态展示（Spinner + 文本），并处理缩放适配。
- [x] 梳理官方文档中 Nano Banana Pro 与 Nano Banana 在各宽高比下的尺寸表，并提炼统一尺寸映射策略。
- [x] 初步实现基于模型 + 宽高比 + 尺寸档位的占位符尺寸推导逻辑（以代码预览形式存在，待统一验证与细化）。
- [x] 在 ImageElement 增加生成状态标记并在 Canvas 中呈现占位 + 转圈（`src/types/index.ts`、`src/components/Canvas.tsx`）。
- [x] 在 useGenerationPipeline 中落地新的占位符流程（请求前插入占位、成功替换、失败清理），并适配文本生图 / 编辑生成 / 掩膜重绘三种模式（`src/hooks/useGenerationPipeline.ts`）。
- [x] 统一三种模式的占位策略：文本生图居中插入、编辑生成在选区右侧插入、掩膜重绘直接在原图上显示转圈并替换原图。
- [x] 统一 Spinner 主题为紫色并移除 JSX 注释，符合代码规范与 UI 标准（`src/components/Canvas.tsx`）。
- [x] 完成 eslint 与 TypeScript 类型检查（修复 `boardsStorage.ts` 服务端 slim 函数参数缺失导致的 TS 错误）。
- [x] 新增占位符尺寸校验脚本（`scripts/test-placeholder.mjs`），验证映射表与推导逻辑一致。
- [x] 扩展 `scripts/test-banana.mjs`：加入错误场景注入与生成尺寸一致性断言输出。
- [x] 覆盖多模型/多宽高比/多分辨率占位尺寸推导用例（`scripts/test-placeholder.mjs` 扩展至 108 组用例，全部通过）。
- [x] 增强真实生成尺寸断言覆盖度（`scripts/test-banana.mjs` 新增 `nano-banana-2` 2K `21:9`、以及 `nano-banana` 1K `16:9`/`21:9` 等断言节点）。
- [x] 移除 PromptBar 调试开关 UI，改为仅通过 `localStorage('debug.gen.fail')` 后台注入错误场景；避免误触（保留管线级清理逻辑）。
- [x] 本地开发服务器已启动并打开预览（`http://localhost:3002/`），完成验证准备。

#### 进行中

- [ ] 补充错误与异常场景测试（通过 `localStorage('debug.gen.fail')` 手动注入），确保不会出现“加载中状态卡死”或占位元素无法移除的问题。
  - 覆盖三种模式（文本生图/编辑生成/掩膜重绘），逐项验证占位清理与状态恢复。

#### 待办



### 执行者反馈或请求帮助（本阶段约定）

- 执行者在开始实现前，应从“进行中/待办”中选择具体任务，将其拆分为 1–3 个可执行的小步骤，并在本节记录：涉及的文件、核心改动点、预期风险。
- 实现完成后：
  - 在“项目状态看板（生图链路与占位符优化）”中更新对应条目状态。
  - 在本节补充：实际改动摘要、所做验证（包括手动场景和自动化测试）、发现的问题与后续建议。
  - 若在实现过程中发现现有尺寸映射无法覆盖新需求（例如增加新的宽高比或特殊分辨率），需要在此提出由规划者评估是否调整整体方案。

### 当前状态/进度跟踪（生图链路与占位符优化）

- 规划者：已根据 Gemini 官方文档整理各模型的尺寸表，并给出基于“模型 + 宽高比 + 尺寸档位”的统一占位尺寸推导思路，以及三种生图模式下的高层占位策略与任务拆分。
- 执行者：本轮补充与验证：
  - 扩展占位尺寸推导用例至 108 组，全部通过（`npm run test:placeholder`）。
  - 增加真实生成断言覆盖，验证不同模型与宽高比的像素与映射表一致（`npm run test:banana` 在有 API 环境下执行）。
  - 运行 `npm run lint` 与 `npx tsc --noEmit`，当前无新增 lint 或类型错误。
  - 已移除 PromptBar UI 调试开关，改为使用 `localStorage('debug.gen.fail')` 进行后台错误注入测试；完成掩膜与编辑管线的占位清理验证。
