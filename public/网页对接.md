# p 站（iframe）→ b 站（宿主）Prompt 同步对接说明（v1）

适用场景：`https://b.vividai.com.cn/` 页面内嵌 `https://p.vividai.com.cn/` iframe；用户在 p 站执行“复制 prompt”后，b 站的 PromptBar 自动填入同一段文本。

核心原则：
- 不依赖“读取剪贴板再填入”（浏览器限制多、失败率高）
- 在“复制动作发生时”，由 p 站直接把同一份文本通过 `postMessage` 发给 b 站
- `targetOrigin` 不写死：通过握手动态获得宿主 `origin`

---

## 1. 通信与安全约束

- 通信通道：`window.postMessage`
- 角色：
  - Host：b 站（父窗口 `window`）
  - Child：p 站（iframe 内 `window`）
- 安全校验（双方都要做）：
  - Host 校验：`event.origin` 必须等于 iframe `src` 的 `origin`，且 `event.source` 必须为该 iframe 的 `contentWindow`
  - Host 校验：`sessionId` 必须匹配当前打开工作区生成的会话 id
  - Child 校验：只接受 `event.source === window.parent` 的握手消息；握手前不向 `'*'` 广播 prompt

---

## 2. 消息协议（JSON）

统一字段：
- `type: string`
- `version: 1`
- `sessionId: string`（一次打开工作区生成一次）

### 2.1 Host → Child：VIVIDAI_INIT（握手）

用途：让 Child 学到 Host 的真实 `origin`，并建立本次会话的 `sessionId`。

```json
{
  "type": "VIVIDAI_INIT",
  "version": 1,
  "sessionId": "bws_1730000000000_abcd1234",
  "capabilities": { "promptSync": true },
  "requestReady": true
}
```

Child 行为：
- 校验 `event.source === window.parent`
- `hostOrigin = event.origin`（这是后续发送 prompt 的动态 `targetOrigin`）
- 保存 `sessionId`
- 回发 `VIVIDAI_READY`

### 2.2 Child → Host：VIVIDAI_READY（可选但强烈建议）

```json
{
  "type": "VIVIDAI_READY",
  "version": 1,
  "sessionId": "bws_1730000000000_abcd1234"
}
```

### 2.3 Child → Host：VIVIDAI_PROMPT（同步内容）

用途：把 prompt 文本同步到 b 站 PromptBar。

```json
{
  "type": "VIVIDAI_PROMPT",
  "version": 1,
  "sessionId": "bws_1730000000000_abcd1234",
  "prompt": "your prompt text...",
  "meta": { "source": "copy_button", "ts": 1730000000123 }
}
```

约束：
- `prompt` 必须为字符串
- 建议长度上限：20000 字符（超出则由 Host 截断，或 Child 先截断）

### 2.4 Host → Child：VIVIDAI_PROMPT_ACK（可选）

```json
{
  "type": "VIVIDAI_PROMPT_ACK",
  "version": 1,
  "sessionId": "bws_1730000000000_abcd1234",
  "ok": true
}
```

失败示例：
```json
{
  "type": "VIVIDAI_PROMPT_ACK",
  "version": 1,
  "sessionId": "bws_1730000000000_abcd1234",
  "ok": false,
  "reason": "session_mismatch"
}
```

---

## 3. 时序（文字版）

1) b 站打开工作区并加载 iframe  
2) b → p：发送 `VIVIDAI_INIT(sessionId)`  
3) p 保存 `hostOrigin = event.origin`，并 p → b：回 `VIVIDAI_READY(sessionId)`  
4) 用户在 p 站点击“复制”或触发 copy 行为  
5) p → b：发送 `VIVIDAI_PROMPT(sessionId, prompt)`，其中 `targetOrigin = hostOrigin`  
6) b 收到后校验 origin + sessionId，通过则写入 PromptBar  
7) （可选）b → p：回 `VIVIDAI_PROMPT_ACK`

补充说明：
- Host 侧 `targetOrigin` 不需要写死，可从 iframe 的 `src` 动态解析得到其 `origin`
- Child 侧 `targetOrigin` 不需要写死，可从握手事件的 `event.origin` 动态获得宿主 `origin`

---

## 4. p 站实现要点（伪代码）

### 4.1 初始化监听（握手 + 缓存待发 prompt）

```js
let hostOrigin = null;
let sessionId = null;
let pendingPrompt = null;

window.addEventListener('message', (event) => {
  if (event.source !== window.parent) return;
  const data = event.data || {};
  if (data.type !== 'VIVIDAI_INIT' || data.version !== 1) return;

  hostOrigin = event.origin;
  sessionId = String(data.sessionId || '');

  window.parent.postMessage(
    { type: 'VIVIDAI_READY', version: 1, sessionId },
    hostOrigin
  );

  if (pendingPrompt) {
    sendPrompt(pendingPrompt, 'deferred');
    pendingPrompt = null;
  }
});

function sendPrompt(text, source) {
  const prompt = String(text ?? '');
  if (!hostOrigin || !sessionId) {
    pendingPrompt = prompt;
    return;
  }
  window.parent.postMessage(
    { type: 'VIVIDAI_PROMPT', version: 1, sessionId, prompt, meta: { source, ts: Date.now() } },
    hostOrigin
  );
}
```

### 4.2 触发点（复制按钮优先）

```js
async function onCopyPromptClick(promptText) {
  try { await navigator.clipboard.writeText(promptText); } catch {}
  sendPrompt(promptText, 'copy_button');
}
```

### 4.3 兼容 Ctrl+C（可选）

```js
document.addEventListener('copy', () => {
  const text = (window.getSelection?.().toString() || '').trim();
  if (text) sendPrompt(text, 'copy_event');
});
```

---

## 5. 联调验收清单

- 基础链路
  - p 站点击“复制 prompt”按钮后，b 站 PromptBar 立即出现相同文本
  - 连续复制 5 次，b 站始终展示最后一次内容
- 异常与边界
  - p 站剪贴板写入失败时（权限/浏览器限制），仍能同步到 b 站（因为不依赖 readText）
  - prompt > 20000 字符时：b 站截断或按约定处理，页面不崩溃不卡顿
  - iframe 刷新后：重新握手后仍可同步
- 安全
  - sessionId 不匹配：b 站拒收且不写入（必要时回 ACK）
  - 非 `*.vividai.com.cn` origin：b 站拒收且不写入
- 调试信息
  - p 站控制台至少打印：`INIT/READY/PROMPT` 的 `{origin, sessionId, promptPreview}`（预览建议截断）
  - b 站控制台至少打印：收到消息的 `{origin, type, sessionId}` 与拒收原因
